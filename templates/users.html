<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body data-page="{{ current_page }}" data-user="{{ logged_in_user }}">
    <div class="sidebar" id="sidebar">
        <!-- Sidebar content -->
    </div>

    <div class="main-content">
    {% if logged_in_user %}
      <div class="user-greeting">
        Logged in as <strong>{{ logged_in_user }}</strong>
      </div>
    {% endif %}
    
    <h2>User Management</h2>

    <button onclick="loadUsers()">🔄 Refresh</button>

    <table id="users-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Department</th>
            <th>Role</th>
            <th>Status</th>
            <th>Last Login</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
let rolesList = [];

// Load roles once
function loadRoles() {
    return fetch('/get-roles')
        .then(response => response.json())
        .then(data => {
            rolesList = data;
        });
}

function loadUsers() {
    fetch('/get-users')
        .then(response => response.json())
        .then(users => {
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                const roleOptions = rolesList.map(role => 
                    `<option value="${role.role_id}" ${role.role_name === user.role_name ? 'selected' : ''}>
                        ${role.role_name}
                    </option>`
                ).join('');

                row.innerHTML = `
                    <td>${user.employee_id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.department}</td>
                    <td>${user.role_name}</td>
                    <td>${user.status}</td>
                    <td>${user.last_login ? new Date(user.last_login).toLocaleString() : '-'}</td>
                    <td>
                        <select id="role-select-${user.employee_id}">
                            ${roleOptions}
                        </select>
                        <button onclick="updateRole(${user.employee_id})">✅ Update</button>
                        <button onclick="toggleStatus(${user.employee_id}, '${user.status}')">
                            ${user.status === 'active' ? '🔒 Deactivate' : '🔓 Activate'}
                        </button>
                        <button onclick="confirmDelete(${user.employee_id}, '${user.email}')">🗑️ Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(err => {
            console.error("Failed to load users:", err);
            alert("Could not load users.");
        });
}

function updateRole(userId) {
    const newRoleId = document.getElementById(`role-select-${userId}`).value;
    fetch(`/update-role/${userId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role_id: newRoleId })
    })
    .then(res => res.json())
    .then(response => {
        alert(response.message || response.error);
        loadUsers();
    })
    .catch(err => console.error("Update role error:", err));
}

function toggleStatus(userId, currentStatus) {
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
    fetch(`/toggle-status/${userId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
    })
    .then(res => res.json())
    .then(response => {
        alert(response.message || response.error);
        loadUsers();
    })
    .catch(err => console.error("Toggle status error:", err));
}

// Run both on page load
window.onload = () => {
    loadRoles().then(loadUsers);
};
</script>
